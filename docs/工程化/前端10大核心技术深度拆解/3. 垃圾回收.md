# 垃圾回收
- 来自通义千问
V8 引擎的垃圾回收（Garbage Collection, GC）机制是其性能优化的核心组成部分之一，它自动管理内存，回收不再使用的对象所占用的空间，防止内存泄漏。V8 的垃圾回收机制主要基于**分代回收（Generational Collection）**的思想，并结合了多种算法来高效处理不同生命周期的对象。

以下是 V8 垃圾回收机制的核心原理和流程：

---

### 1. 内存分代（Generational Hypothesis）
V8 将堆内存（Heap）划分为不同的代（Generation），基于一个经验性的观察：**大多数对象的生命周期都很短，而存活下来的对象往往会长期存在**。

因此，V8 将内存分为两个主要区域：

*   **新生代（Young Generation / New Space）**：
    *   存放**新创建的、生命周期较短**的对象。
    *   空间相对较小，GC 频繁发生。
    *   使用 **Scavenge 算法**（具体是 **Cheney 算法**）进行回收。

*   **老生代（Old Generation / Old Space）**：
    *   存放**经过多次回收后仍然存活**的对象。
    *   空间较大，GC 发生频率较低，但每次回收耗时更长。
    *   使用 **Mark-Sweep（标记清除）** 和 **Mark-Compact（标记整理）** 算法进行回收。

---

### 2. 新生代回收：Scavenge 算法

新生代空间被划分为两个等大的半空间（Semispace）：

*   **From 空间（活动空间）**：当前正在使用的空间。
*   **To 空间（空闲空间）**：空闲，等待使用。

**回收过程如下**：

1.  **检查对象**：当 From 空间被填满时，触发一次 Minor GC。
2.  **复制存活对象**：遍历 From 空间中的所有对象，将**存活的对象**复制到 To 空间。
3.  **晋升（Promotion）**：如果某个存活对象**已经经历过一次 Scavenge 回收**，或者 To 空间**空间不足**，则该对象会被直接晋升到老生代。
4.  **清理与交换**：清空 From 空间（直接丢弃所有未复制的对象，即“垃圾”），然后将 From 和 To 空间角色互换。

**优点**：速度快，适合处理大量短生命周期对象。
**缺点**：空间利用率只有50%，且涉及对象复制。

---

### 3. 老生代回收：Mark-Sweep & Mark-Compact

老生代对象多且存活率高，不适合使用 Scavenge 算法。V8 采用更复杂的算法：

#### (1) 标记阶段（Marking）
*   从**根对象**（如全局对象、调用栈中的变量等）开始，递归遍历所有可达对象，并给它们打上“存活”标记。
*   不可达的对象即为“垃圾”。

#### (2) 清除阶段（Sweeping）
*   遍历整个老生代空间，回收所有**未被标记**的对象所占用的内存。

#### (3) 整理阶段（Compacting）
*   **问题**：Mark-Sweep 会导致内存碎片化，影响后续大对象分配效率。
*   **解决**：Mark-Compact 算法在清除后，将所有存活对象向内存的一端移动，从而**整理内存，消除碎片**。

---

### 4. 增量标记（Incremental Marking）
为了减少 GC 对主线程的长时间阻塞（停顿时间过长会影响用户体验），V8 引入了**增量标记**技术：

*   将原本需要一次性完成的标记过程，**拆分成多个小步骤**。
*   每个步骤执行很短时间，然后让 JavaScript 代码继续执行，交替进行。
*   这样可以将长停顿（Stop-The-World）分解为多个短停顿，提升页面响应性。

---

### 5. 并发与并行回收
现代 V8 进一步优化，引入了更高级的并发机制：

*   **并行回收（Parallel）**：在主线程执行 GC 时，**启动多个辅助线程**，协同完成标记或清理工作，**共享停顿时间**。
*   **并发回收（Concurrent）**：某些阶段（如标记）可以在**辅助线程上独立运行**，而**主线程可以继续执行 JavaScript 代码**，极大减少停顿。
*   **惰性清理（Lazy Sweeping）**：标记完成后，清理工作可以延迟进行，或分批执行，避免一次性开销过大。

---

### 总结

| 特性 | 新生代（Young Generation） | 老生代（Old Generation） |
| :--- | :--- | :--- |
| **对象特点** | 生命周期短，创建频繁 | 生命周期长，存活率高 |
| **回收算法** | Scavenge (Cheney) | Mark-Sweep + Mark-Compact |
| **GC 类型** | Minor GC | Major GC |
| **触发频率** | 高频 | 低频 |
| **优化技术** | - | 增量标记、并发回收、并行回收、惰性清理 |

---

### 对开发者的意义

1.  **避免内存泄漏**：及时解除对不再需要对象的引用（如事件监听器、定时器、闭包变量）。
2.  **减少大对象频繁创建**：大对象会直接进入老生代，增加 Major GC 压力。
3.  **理解性能瓶颈**：长时间的 GC 停顿可能导致页面卡顿，可通过 Chrome DevTools 的 Memory 面板分析内存使用和 GC 行为。

V8 的垃圾回收机制是一个高度优化、持续演进的系统，旨在在内存效率和程序性能之间取得最佳平衡。
