# Common.js
http://javascript.ruanyifeng.com/nodejs/module.html
#### 起源
1. 2009年，美国程序员Ryan Dahl创造了node.js项目，将javascript语言用于服务器端编程。这标志"Javascript模块化编程"正式诞生
#### 概述
1. 主要用于服务端 Node里面
1. Node.js 就是采用的 CommonJS 模块化
2. 每个文件就是一个模块,有自己的作用域.在一个文件里面定义的变量、函数、类,都是私有的,对其他的文件不可见.
3. CommonJS规范规定，每个模块内部，module变量代表当前模块。这个变量是一个对象，它的exports属性（即==module.exports==）是对外的接口。加载某个模块，其实是加载该模块的module.exports属性。
```
 var x = 5;
 var addX = function (value) {
  return value + x;
};
 module.exports.x = x;
 module.exports.addX = addX;
```
4. require方法用于加载模块。
```
 var example = require('./example.js');
 console.log(example.x); // 5
 console.log(example.addX(1)); // 6
```
#### CommmonJS 特点
- 所有代码都运行在模块作用域，不会污染全局作用域。
- 模块可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。
- 模块加载的顺序，按照其在代码中出现的顺序。


#### module对象
```
module.id 模块的识别符，通常是带有绝对路径的模块文件名。
module.filename 模块的文件名，带有绝对路径。
module.loaded 返回一个布尔值，表示模块是否已经完成加载。
module.parent 返回一个对象，表示调用该模块的模块。
module.children 返回一个数组，表示该模块要用到的其他模块。
module.exports 表示模块对外输出的值。
```
#### require命令
1. Node使用CommonJS模块规范，内置的require命令用于加载模块文件。

#### CommonJS的本质
[B站](https://www.bilibili.com/video/BV11iP5eJEz6)
- 所有的模块的执行过程都在函数环境中
- 最终导出的是 module.exports
```javascript
 // common.js 的本质
 // 所有的模块的执行过程都在函数环境中
 // 最终导出的是 module.exports 导出的对象
 // 1.js
 const r = require('./2');

 // require 伪代码 模拟模块加载
 function require(modulePath) {
     // 1. 根据传递的模块路径, 得到模块完整的路径
     var moduleId = getModuleId(modulePath);

     // 2. 判断缓存
     if(cache[moduleId]){
         return cache[moduleId];
     }

     //3. 真正运行模块代码的辅助函数
     function _require(exports, require, module, __filename, __dirname) {
         // 目标模块的代码在这里

     }
     // 为模块执行创建参数
     var module = {
         exports: {},
     };
     var filename = moduleId;
     return module.exports;
 }
```

#### AMD规范与 CommonJS规范的兼容性
1. CommonJS规范加载模块是同步的，也就是说，只有加载完成，才能执行后面的操作。AMD规范则是非同步加载模块，允许指定==回调函数==。
2. 由于Node.js主要用于服务器编程，模块文件一般都已经存在于本地硬盘，所以加载起来比较快，==不用考虑非同步加载的方式==，所以CommonJS规范比较适用。但是，如果对于浏览器，这却是一个大问题，因为模块都放在服务器端，等待时间取决于网速的快慢，可能要等很长时间，浏览器处于"假死"状态。要从服务器端加载模块，这时就必须采用非同步模式，因此浏览器端一般采用AMD规范。


#### CMD规范
1. CMD规范专门用于浏览器端，模块的加载是异步的，模块使用时才会加载执行。代表作品: seaJs
2. CMD规范整合了CommonJS和AMD规范的特点。
