# Fiber架构的一切
- [B站面试口喷](https://www.bilibili.com/video/BV1ML411S7Fw)
- [掘金](https://juejin.cn/post/7427778132608172073)
## 什么是fiber架构
- 定义:描述了当前要创建的真实 dom 的一些信息，以及这个描述对象要做的操作】这个描述对象叫 ``fiber``
- 思想: 借鉴于计算机操作系统CPU的调度机制.
- 出现原因: 
  - react16()之前采用的递归方式(递归 + 调用栈)遍历 创建,更新虚拟DOM 递归的过程是不能中断的. ``堆栈调和（Stack Reconciliation）机制``
  - 递归这一过程可能占用很长时间. js又是单线程的.递归时UI渲染线程会一直处于等待中,导致页面卡顿.
  - 在React16.8中引入fiber架构, 创建和更新虚拟DOM采用``深度优先遍历``.
- 主要功能:
  1. ``动态优先级``
     - 给每个任务分配一个权重值.实现动态调整任务的执行顺序.优先级高的任务会先执行.
  2. ``可中断,可放弃(回滚)渲染``
     - 允许react渲染过程中对任务进行暂停.适当的时机进行重启.
     - 渲染过程分帧进行(使用了浏览器的2个api实现:requestAnimationFrame, requestIdleCallback)
     - 如果渲染时某任务的执行时间超过了当前帧的一个剩余时间,则进行任务暂停.保证不阻塞浏览器渲染.把控制器交给浏览器去执行UI渲染.下一帧再执行没有完成的任务.

![img_8.png](img_8.png)
![img_9.png](img_9.png)
## Fiber的结构: fiber节点树
- 在React的Fiber架构中，Fiber节点是构成Fiber树的基本单元，代表了React组件的虚拟DOM。
- 每个Fiber节点对应于屏幕上的某个组件或DOM元素，并且包含了渲染该组件或元素所需的所有信息。
- 每个Fiber是``独立``的工作单元，这使得渲染过程变得更容易调度。
- 遍历顺序: 父节点->子节点->兄弟节点(深度优先)
- https://juejin.cn/post/7427778132608172073#heading-5
- https://juejin.cn/post/7431122270641094675#heading-0

![img_10.png](img_10.png)

### 节点需要更新时:
- 除了用于显示当前UI的树``current``外，Fiber还会创建一个``workInProgress``树，变动的更新会在其上进行处理，处理完毕后用于下一次渲染，并替代之前的current树变为新的current树。

## 优先级是如何确定的?
- 在React Fiber架构中，优先级的确定是一个复杂而精细的过程，它涉及多种因素和策略。以下是对React Fiber中优先级确定方式的详细分析：

#### 一、优先级类型与划分

- React Fiber为不同的任务分配了不同的优先级，这些优先级通常根据任务的紧急程度和重要性来划分。常见的优先级类型包括：

1. **用户交互事件**：这类事件（如点击按钮、输入框输入等）触发的任务具有最高的优先级，因为它们直接影响用户体验，需要立即响应。
2. **动画和过渡效果**：动画和过渡效果的流畅性对用户体验也较为重要，因此其相关的任务优先级仅次于用户交互事件。
3. **数据加载和渲染**：从服务器获取数据以及初始页面的渲染等任务相对来说优先级较低，这些任务通常不会直接影响用户的即时交互体验。
4. **同步任务与异步任务**：同步任务（如需要立即执行以保证程序正常运行或满足用户当前交互需求的任务）的优先级高于异步任务（如延迟加载的数据请求或定时执行的任务）。

#### 二、动态调整优先级

- React Fiber的优先级调度机制不仅基于任务的类型，还会根据以下因素动态调整任务的优先级：
- https://juejin.cn/post/7441798757104861235
1. **截止时间临近**：如果某个任务有明确的截止时间，且临近截止时间时还未完成，那么该任务的优先级会相应提高。
2. **可见区域内的组件**：对于当前可见区域内的组件，其相关的任务优先级会相对较高，因为这些组件直接影响用户当前所看到的页面内容和交互体验。
3. **关键路径上的组件**：关键路径是指从应用启动到完成核心功能所必须经过的一系列组件和操作。关键路径上的组件更新任务会具有较高优先级。
4. **用户行为**：根据用户的操作行为和当前的交互场景，React会动态地调整任务的优先级。例如，当用户频繁地在页面的某个区域进行交互时，该区域相关组件的任务优先级会被进一步提高。
5. **性能状况**：如果系统检测到当前设备的性能状况不佳，React会适当降低一些非关键任务的优先级，以避免对系统性能造成更大的压力。

#### 三、优先级队列与调度策略

- React会根据上述的优先级确定规则，将不同的任务放入相应的优先级队列中。每个优先级队列对应一个特定的优先级级别，高优先级队列中的任务会优先得到处理。

- 在执行任务时，React的调度器会按照优先级队列的顺序依次处理任务。当高优先级队列中有任务时，低优先级队列中的任务会被暂时搁置，直到高优先级队列中的任务全部处理完毕。同时，调度器还会根据当前系统的资源状况和任务的紧急程度，合理分配时间片给不同优先级的任务，确保高优先级任务能够及时得到处理，同时也不会让低优先级任务长时间得不到执行。

#### 四、总结

- React Fiber通过综合考虑任务的类型、紧急程度、用户行为、系统性能等多种因素，动态地确定和调整任务的优先级。
- 这种优先级调度机制使得React能够更加智能地管理任务的执行顺序，在保证用户交互体验的同时，充分利用系统资源，提高应用的整体性能和响应速度。


