# Dom的创建
在 React 的渲染流程中，**DOM 元素的创建发生在 `completeWork` 阶段，属于 Render/Reconciliation 阶段的一部分，但具体的 DOM 插入（挂载到页面）则发生在 Commit 阶段。**

这是一个非常关键的区别，理解这一点有助于掌握 React 的双阶段更新机制。

### 详细分解

#### 1. Render/Reconciliation 阶段 (可中断)

这个阶段的目标是找出需要进行的变更，并为这些变更做准备。它包含两个主要函数：`beginWork` 和 `completeWork`。

*   **`beginWork` 阶段**：
    *   这个阶段主要是“计划”工作。
    *   对于一个类组件或函数组件，React 会调用其 `render()` 方法或执行函数体，得到新的 JSX 结构。
    *   根据新的 JSX，React 会创建或复用对应的 Fiber 节点，构建一个新的 Fiber 树（称为 `workInProgress` 树）。
    *   **此时不会创建任何 DOM 元素。**

*   **`completeWork` 阶段**：
    *   当遍历到达一个**叶子节点**（如 `<div>`、`<span>` 等原生 DOM 组件）并且该节点没有子节点时，或者处理完一个子树后回溯到该节点时，会进入 `completeWork`。
    *   **✅ 在这里，React 会调用平台相关的 API（如 `document.createElement`、`document.createTextElement`）来创建实际的 DOM 元素或文本节点。**
    *   同时，React 会将计算好的 props（如 `className`、`onClick` 等）设置到这个新创建的 DOM 元素上。
    *   这个新创建的 DOM 元素会被**关联到当前的 Fiber 节点**上（通过 `stateNode` 属性）。
    *   **重要：此时创建的 DOM 元素还只是内存中的对象，尚未插入到真实的页面 DOM 树中。**

#### 2. Commit 阶段 (不可中断)

这个阶段是同步的，必须一次性完成，以确保 UI 更新的原子性。

*   **Mutation 阶段**：
    *   React 遍历在 Reconciliation 阶段构建好的 **Effect List**（包含了所有需要插入、更新或删除的 Fiber 节点）。
    *   **✅ 在这里，React 会执行真正的 DOM 操作。对于新创建的 DOM 元素，会调用 `parentNode.appendChild()` 或类似方法，将其从内存中的对象正式“挂载”到浏览器的 DOM 树中，用户才能看到。**
    *   同样，在这个阶段也会执行 DOM 更新和删除操作。

### 为什么这样设计？(分阶段的好处)

1.  **可中断性**：`completeWork` 中的 DOM 创建虽然是同步的，但由于它发生在 Reconciliation 阶段，而整个 Reconciliation 是可中断的。如果创建过程很耗时，React 可以暂停，避免阻塞主线程太久。
2.  **原子性更新**：将所有 DOM 操作（插入、更新、删除）延迟到 Commit 阶段统一执行，可以确保用户看到的 UI 更新是瞬间完成的，避免了中间状态的闪烁。
3.  **性能优化**：React 可以在 Commit 阶段对多个 DOM 操作进行批处理和优化。

### 总结

| 阶段 | 操作 | 是否可见 |
| :--- | :--- | :--- |
| **Render/Reconciliation -> `completeWork`** | **创建 DOM 元素** (`document.createElement`) | ❌ 不可见（仅在内存中） |
| **Commit -> Mutation 阶段** | **插入 DOM 元素** (`appendChild`) | ✅ 可见（挂载到页面） |

所以，准确地说：**DOM 元素的创建（Creation）在 `completeWork` 阶段完成，而 DOM 元素的插入/挂载（Insertion/Mounting）在 Commit 阶段完成。**
