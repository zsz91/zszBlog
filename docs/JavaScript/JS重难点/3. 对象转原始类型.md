# 对象转原始类型

在 JavaScript 中，当一个对象需要被转换为原始类型（如字符串、数字、布尔值）时，引擎会遵循一套明确的、标准化的步骤。这个过程主要由 **`ToPrimitive` 抽象操作** 定义。

转换的具体步骤取决于**期望的类型（hint）**，期望类型通常由操作的上下文决定。

---

### 1. `ToPrimitive` 操作的通用步骤

当 JavaScript 需要将对象转换为原始值时，会执行 `ToPrimitive(object, hint)`，其中 `hint` 可以是 `"number"`、`"string"` 或 `"default"`。

1.  **如果对象有 `valueOf()` 方法且返回原始值**：
    *   调用 `object.valueOf()`。
    *   如果返回值是**原始类型**（number, string, boolean, null, undefined），则返回该值。
    *   如果返回值是对象，则继续下一步。

2.  **如果对象有 `toString()` 方法且返回原始值**：
    *   调用 `object.toString()`。
    *   如果返回值是**原始类型**，则返回该值。
    *   如果返回值是对象，则继续下一步。

3.  **抛出错误**：
    *   如果以上两个方法都没有返回原始值，则抛出 `TypeError`。

---

### 2. `hint` 的作用

`hint` 决定了 `valueOf` 和 `toString` 的调用**优先级**。

| `hint` 类型 | 优先调用的方法 | 常见场景 |
| :--- | :--- | :--- |
| **`"number"`** | 先 `valueOf()`，后 `toString()` | `+obj`, `Number(obj)`, `Math.abs(obj)`, 日期计算等 |
| **`"string"`** | 先 `toString()`，后 `valueOf()` | `String(obj)`, 模板字符串 `` `${obj}` ``, `obj + ""` |
| **`"default"`** | 行为类似于 `"number"`<sup>*</sup> | 二元 `+` 操作符 (`obj1 + obj2`)，`==` 比较 |

> **\* 关于 `"default"` 的特殊情况**：
> 对于大多数内置对象（如 `Date` 和 `Symbol`），`"default"` 的行为会**优先调用 `toString()`**，而不是 `valueOf()`。这是为了保持向后兼容性。`Date` 对象在 `+` 操作中会优先转为字符串。

---

### 3. 实际例子

#### 例 1: `hint = "number"` (`+obj`)
```javascript
const obj = {
  valueOf() { return 42; },
  toString() { return "hello"; }
};

console.log(+obj); // 42
// 步骤: 先调用 valueOf() -> 返回 42 (原始值) -> 使用 42
```

#### 例 2: `hint = "string"` (模板字符串)
```javascript
const obj = {
  valueOf() { return 42; },
  toString() { return "hello"; }
};

console.log(`${obj}`); // "hello"
// 步骤: 先调用 toString() -> 返回 "hello" (原始值) -> 使用 "hello"
```

#### 例 3: `hint = "default"` (`obj1 + obj2`)
```javascript
const obj1 = {
  valueOf() { return 10; },
  toString() { return "A"; }
};
const obj2 = {
  valueOf() { return 20; },
  toString() { return "B"; }
};

console.log(obj1 + obj2); // 30
// 步骤: 由于 hint 是 "default"，先尝试 valueOf()
// obj1.valueOf() -> 10, obj2.valueOf() -> 20, 10 + 20 = 30
```

#### 例 4: `Date` 对象的特殊性 (`hint = "default"`)
```javascript
const date = new Date();

console.log(date + ""); // "Wed Oct 26 2023 12:00:00 GMT+0800 (中国标准时间)"
// 虽然 hint 是 "default"，但 Date 对象会优先调用 toString()
```

#### 例 5: 返回对象时
```javascript
const obj = {
  valueOf() { return {}; }, // 返回对象
  toString() { return {}; }  // 返回对象
};

// console.log(+obj); // TypeError: Cannot convert object to primitive value
```

---

### 4. 布尔值转换 (特殊情况)

将对象转换为布尔值是一个例外。**所有对象（包括空对象 `{}` 和空数组 `[]`）在布尔上下文中都转换为 `true`**。

```javascript
console.log(Boolean({})); // true
console.log(Boolean([])); // true
console.log(Boolean(new Boolean(false))); // true (这是一个对象!)
```

只有 `null` 和 `undefined` 以及 6 个“falsy”原始值 (`false`, `0`, `-0`, `0n`, `""`, `NaN`) 会转换为 `false`。

---

### 总结

1.  对象转原始类型由 `ToPrimitive` 操作控制。
2.  优先调用 `valueOf()` 还是 `toString()` 取决于 `hint`（上下文）。
3.  `hint` 为 `"number"` 时优先 `valueOf()`，为 `"string"` 时优先 `toString()`。
4.  `+` 操作符使用 `"default"` hint，通常优先 `valueOf()`，但 `Date` 等对象例外。
5.  所有对象转布尔值都是 `true`。

理解这个过程对于预测复杂表达式的行为至关重要，尤其是在涉及自定义对象和重载 `valueOf`/`toString` 时。
